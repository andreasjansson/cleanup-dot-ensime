#!/usr/bin/env python

from subprocess import Popen
import fileinput
import re
import sys
import os

def remove_bad_jar(match):
    jar_filename = match.group(1)
    if is_valid_jar(jar_filename):
        return '"%s"' % jar_filename
    else:
        sys.stderr.write('Invalid or missing jar file: %s\n' % jar_filename)
        return ''

def is_valid_jar(jar_filename):
    with open(os.devnull, 'wb') as devnull:
        return Popen(['zip', '-T', jar_filename], stdout=devnull, stderr=devnull).wait()

def main():
    for line in fileinput.input():
        sys.stdout.write(re.sub('"([^"]+.jar)"', remove_bad_jar, line))

def usage():
    print '''
Remove bad lines from .ensime files generated by gen-ensime.

Run this script after gen-ensime, for example:

    sbt gen-ensime
    mv .ensime .ensime.original
    cleanup-dot-ensime .ensime.original > .ensime

References:
 * https://github.com/ensime/ensime-server/issues/825
'''

if __name__ == '__main__':
    if len(sys.argv) > 1 and sys.argv[1] in ('-h', '--help'):
        usage()
    else:
        main()
